name: CI

on:
  push:
    branches: [ main, test/vm-setup ]
  pull_request:
    branches: [ main ]

jobs:
  # ─── Job 1: Lint Ansible Playbooks ──────────────────────────────────────────
  ansible-lint:
    name: Lint Ansible
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install ansible-core ansible-lint

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r ansible/requirements.yml

      - name: Run ansible-lint
        run: ansible-lint ansible/site.yml

  # ─── Job 2: Validate chezmoi Templates ──────────────────────────────────────
  chezmoi-validate:
    name: Validate chezmoi Templates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install chezmoi
        run: sh -c "$(curl -fsLS get.chezmoi.io)"

      - name: Validate chezmoi config template (dry-run)
        run: ./bin/chezmoi init --dry-run

  # ─── Job 3: Integration Test ─────────────────────────────────────────────────
  integration-test:
    name: Integration Test
    needs: [ansible-lint, chezmoi-validate]
    runs-on: ubuntu-latest
    container:
      image: ubuntu:24.04
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Install base dependencies
        run: |
          apt-get update
          apt-get install -y curl git sudo age python3 ansible snapd

      - name: Create test user
        run: |
          useradd -m -s /bin/bash testuser
          echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

      - name: Mock Bitwarden CLI
        run: |
          cat > /usr/local/bin/bw << 'EOF'
          #!/bin/bash
          case "$1" in
            status)  echo '{"status":"locked"}' ;;
            unlock)  echo "mock-session-token" ;;
            sync)    echo "Syncing..." ;;
            get)     exit 1 ;;  # Simulate no key found in vault
            *)       exit 0 ;;
          esac
          EOF
          chmod +x /usr/local/bin/bw

      - name: Run bootstrap script
        run: |
          cp -r . /home/testuser/dotfiles
          chown -R testuser:testuser /home/testuser/dotfiles
          su testuser -c "cd /home/testuser/dotfiles && ./bootstrap.sh"

      - name: Seed chezmoi config (simulate init answers)
        run: |
          mkdir -p /home/testuser/.config/chezmoi
          cat > /home/testuser/.config/chezmoi/chezmoi.toml << 'EOF'
          encryption = "age"

          [data]
              name = "Test User"
              machine_type = "personal"
              os = "linux"
              editor = "nano"
              personal_email = "test@example.com"
              work_email = ""
              recipient = "age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p"

          [age]
              identity = "/home/testuser/.config/chezmoi/key.txt"
              recipient = "age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p"
          EOF
          chown -R testuser:testuser /home/testuser/.config

      - name: Apply dotfiles
        run: |
          su testuser -c "chezmoi --source /home/testuser/dotfiles apply --force 2>&1 || true"

      - name: ✅ Test - Dotfiles exist
        run: |
          echo "=== Checking dotfiles were created ==="
          PASS=0
          FAIL=0

          check_file() {
            if [ -f "$1" ]; then
              echo "  ✅ $1"
              PASS=$((PASS + 1))
            else
              echo "  ❌ $1 (MISSING)"
              FAIL=$((FAIL + 1))
            fi
          }

          check_file /home/testuser/.bash_aliases
          check_file /home/testuser/.bash_functions
          check_file /home/testuser/.gitconfig
          check_file /home/testuser/.profile

          echo ""
          echo "Results: $PASS passed, $FAIL failed"
          [ "$FAIL" -eq 0 ] || exit 1

      - name: ✅ Test - Ansible common packages installed
        run: |
          echo "=== Checking packages installed by Ansible ==="
          PASS=0
          FAIL=0

          check_pkg() {
            if dpkg -l "$1" 2>/dev/null | grep -q "^ii"; then
              echo "  ✅ $1"
              PASS=$((PASS + 1))
            else
              echo "  ❌ $1 (NOT INSTALLED)"
              FAIL=$((FAIL + 1))
            fi
          }

          check_pkg curl
          check_pkg git
          check_pkg htop
          check_pkg jq

          echo ""
          echo "Results: $PASS passed, $FAIL failed"
          [ "$FAIL" -eq 0 ] || exit 1

      - name: ✅ Test - age key was generated
        run: |
          echo "=== Checking age key ==="
          if [ -f /home/testuser/.config/chezmoi/key.txt ]; then
            echo "  ✅ age key exists"
            PERMS=$(stat -c "%a" /home/testuser/.config/chezmoi/key.txt)
            if [ "$PERMS" = "600" ]; then
              echo "  ✅ age key permissions are 600"
            else
              echo "  ❌ age key permissions are $PERMS (expected 600)"
              exit 1
            fi
          else
            echo "  ❌ age key NOT found"
            exit 1
          fi
